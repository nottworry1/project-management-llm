<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: common-head('Task: ' + ${task.title})}"></head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<main class="container mt-4">
    <h2 th:text="${task.title}">Task Title</h2>
    <p><strong>Description:</strong> <span th:text="${task.description}"></span></p>
    <p><strong>Status:</strong> <span th:text="${task.taskStatus.name}"></span></p>
    <p><strong>Reporter:</strong> <span th:text="${task.reporter.username}"></span></p>

    <a class="btn btn-primary"
       th:href="@{/projects/{projectId}/tasks/{taskId}/edit(projectId=${task.project.id},taskId=${task.id})}">
        Edit
    </a>
    <a class="btn btn-secondary"
       th:href="@{/projects/{projectId}/tasks(projectId=${task.project.id})}">
        Back to Tasks
    </a>

    <h4>Comments</h4>
    <div th:each="comment : ${comments}"
         th:insert="~{fragments/comment :: commentRow(comment)}">
    </div>

    <h5>Add a comment</h5>
    <form th:action="@{/projects/{projectId}/tasks/{taskId}/comments(projectId=${task.project.id},taskId=${task.id})}"
          th:object="${newComment}"
          method="post">
        <div class="mb-3">
            <textarea th:field="*{text}" class="form-control" rows="3"></textarea>
            <div th:replace="~{fragments/error-message :: errorMessage('text')}"></div>
        </div>
        <button class="btn btn-primary">Post Comment</button>
    </form>

    <h4>Attachments</h4>
    <ul>
        <li th:each="att : ${task.attachments}">
            <div th:if="${att.contentType.startsWith('image/')}">
                <a th:href="@{/projects/{projectId}/tasks/{taskId}/attachments/{fn}
                  (projectId=${task.project.id},taskId=${task.id},fn=${att.filePath})}">
                    <img th:src="@{/projects/{projectId}/tasks/{taskId}/attachments/{fn}
                     (projectId=${task.project.id},taskId=${task.id},fn=${att.filePath})}"
                         style="max-width: 200px; max-height: 200px; object-fit:contain;"
                         th:alt="${#strings.substringAfter(att.filePath, '_')}" />
                </a>
            </div>

            <div th:if="${!att.contentType.startsWith('image/')}">
                <a th:href="@{/projects/{projectId}/tasks/{taskId}/attachments/{fn}
                    (projectId=${task.project.id},taskId=${task.id},fn=${att.filePath})}"
                   th:text="${#strings.substringAfter(att.filePath, '_')}">
                    Download
                </a>
            </div>

            <form th:action="@{/projects/{projectId}/tasks/{taskId}/attachments/{id}/delete
                       (projectId=${task.project.id},taskId=${task.id},id=${att.id})}"
                  method="post" style="display:inline">
                <button class="btn btn-link text-danger p-0">Delete</button>
            </form>
        </li>
    </ul>

    <h5>Upload a file</h5>
    <form th:action="@{/projects/{projectId}/tasks/{taskId}/attachments(projectId=${task.project.id},taskId=${task.id})}"
          method="post" enctype="multipart/form-data">
        <div class="mb-3">
            <input type="file" name="file" class="form-control" required/>
        </div>
        <button class="btn btn-secondary">Upload</button>
    </form>

</main>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
